# 更新日志

## v1.2.0 详细更新日志（2025-05-29）

### 🚀 主要新功能

#### 1. 第三方API客户端配置化
- **配置从环境变量读取**: 重构 `api_client.py`，支持从 `.env` 文件读取API配置
- **灵活配置管理**: 添加 `THIRD_PARTY_API_URL`、`THIRD_PARTY_API_KEY` 等环境变量支持
- **易于切换**: 更改API提供商只需修改 `.env` 文件，无需修改代码
- **认证支持**: 自动添加 Bearer Token 认证头

#### 2. 连续对话功能重构
- **智能触发机制**: 支持被@、私聊、唤醒词三种触发方式
- **连续对话模式**: 被触发后180秒内无需重复@或使用唤醒词
- **用户会话管理**: 不同用户独立的连续对话状态
- **自动清理**: 定期清理过期的会话状态，节省内存

#### 3. 消息处理逻辑优化
- **更智能的触发判断**: 优化群聊和私聊的消息处理逻辑
- **状态日志**: 添加详细的连续对话状态日志，便于调试
- **性能优化**: 减少不必要的消息处理，提升响应速度

### 🔧 技术改进

#### 代码结构优化
- **删除冗余文件**: 移除 `api_config.py`，统一使用环境变量配置
- **依赖管理**: 完善虚拟环境和依赖安装流程
- **错误处理**: 增强API调用的错误处理和重试机制

#### 配置管理
- **环境变量标准化**: 统一使用 `.env` 文件管理所有配置
- **配置验证**: 添加配置完整性检查和警告提示
- **向下兼容**: 保持现有配置的向下兼容性

### 🐛 问题修复

- 修复了连续对话状态不正确的问题
- 修复了API客户端配置硬编码的问题
- 修复了群聊中被@后无法连续对话的问题
- 修复了私聊消息处理逻辑

### 📖 文档更新

- 更新API客户端使用文档
- 添加连续对话功能说明
- 完善环境变量配置指南

---

## v1.1.0 详细更新日志（2025-05-29）

### 第一阶段：整合现有高级 Agent（优先级：高）

#### 1.1 集成 ThinkingAgent
- 在对话调度流程中引入思考链生成，机器人回复更有逻辑性和深度。
- 思考过程会被传递给对话生成模块，提升智能感。

#### 1.2 启用 AdvancedEmotionAgent
- 替换原有简单情感分析，升级为基于 LLM 的高级情感识别。
- 自动为回复匹配更贴切的 emoji，表达更丰富。

#### 1.3 使用 EnhancedDialogueAgent
- 替换基础对话生成器，整合思考链和情感分析结果。
- 机器人回复更加自然、智能、有情感。

---

### 第二阶段：实现 MongoDB 持久化存储（优先级：中）

#### 2.1 数据库设计
- 设计用户、会话等数据模型，支持长期数据积累。

#### 2.2 实现步骤
- 新增 `motor` 异步 MongoDB 驱动，支持高并发数据读写。
- 配置环境变量，支持灵活切换本地/云端数据库。
- 实现异步 CRUD 操作和数据缓存，提升性能和可靠性。

---

### 第三阶段：开发动态人格系统（优先级：中）

#### 3.1 人格模型设计
- 支持多维度人格参数（活泼、幽默、正式、共情、创造力、活力等）。

#### 3.2 人格适应机制
- 根据用户互动风格动态调整机器人人格，提升个性化体验。

#### 3.3 实现功能
- 新增 PersonalityAgent，支持多种预设人格模板和自动适应。
- 支持通过命令切换人格模式（如 `/personality formal`、`/personality playful`、`/personality auto`）。

---

### 第四阶段：系统优化与增强（优先级：低）

#### 4.1 性能优化
- 引入智能缓存和并发优化，提升响应速度。
- 添加请求去重机制，防止重复处理。

#### 4.2 功能增强
- 支持多轮对话和上下文理解，提升对话连贯性。
- 预留图片/文件理解接口，便于后续扩展。

#### 4.3 监控与日志
- 增强日志记录和性能监控，便于维护和问题追踪。
- 预留管理面板开发接口。

---

### 其他亮点

- 新增辱骂检测与强力反击功能，机器人遇到辱骂会自动“骂回去”，风格多样，极端辱骂有更强烈回复。
- 优化私信（DM）逻辑，私聊无需唤醒词即可触发机器人回复。
- 配置与数据文件完善，提升易用性和健壮性。
- 代码结构优化，增加详细调试输出，便于开发和维护。

---

**升级建议：**  
请拉取最新代码，检查 `.env` 配置，确保依赖已安装，重启机器人即可体验全部新功能！
